<template>
  <div class="min-h-screen bg-gradient-to-br from-indigo-100 via-white to-purple-100 py-8 px-4">
    <div class="max-w-xl mx-auto bg-white rounded-2xl shadow-xl p-6">
      <h2 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center gap-2">
        <span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      </h2>

      <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á -->
      <div class="mb-4">
        <label class="block text-gray-700 font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á:</label>
        <input v-model="displayName" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
      </div>

      <!-- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö -->
      <div class="mb-4">
        <label class="block text-gray-700 font-semibold mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö:</label>
        <input v-model="favoriteMeat" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π, ‡πÑ‡∏Å‡πà, ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
      </div>
      <div class="mb-4">
  <label class="block text-gray-700 font-semibold mb-1">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏®‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö:</label>
  <input v-model="favoriteSpices" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢, ‡∏¢‡∏µ‡πà‡∏´‡∏£‡πà‡∏≤, ‡∏Ç‡πà‡∏≤..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
</div>

<!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏∏‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö -->
<div class="mb-4">
  <label class="block text-gray-700 font-semibold mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏£‡∏∏‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö:</label>
  <input v-model="favoriteMethods" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏±‡∏î, ‡∏ï‡πâ‡∏°, ‡∏¢‡πà‡∏≤‡∏á..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
</div>

      <div class="mb-4">
        <label class="block text-gray-700 font-semibold mb-1">‡∏ú‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö:</label>
        <input v-model="favoriteVegetables" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á, ‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤, ‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />
      </div>
      <div class="mb-6">
  <label class="block text-gray-700 font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå:</label>
  <div class="grid grid-cols-5 gap-4">
    <img
      v-for="n in 10"
      :key="n"
      :src="`/profile-avatars/avatar${n}.png`"
      :alt="`avatar${n}`"
      class="w-16 h-16 rounded-full cursor-pointer border-2 transition hover:scale-105"
      :class="avatar === `profile-avatars/avatar${n}.png` ? 'border-indigo-500 ring-2 ring-indigo-300' : 'border-gray-300'"
      @click="avatar = `profile-avatars/avatar${n}.png`"
    />
  </div>
  <div class="mt-4 text-center">
    <img :src="`/${avatar}`" alt="preview" class="w-24 h-24 rounded-full border-4 border-indigo-300 mx-auto" />
  </div>
</div>

      <!-- ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
      <div class="mb-6">
        <label class="block text-gray-700 font-semibold mb-1">üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°:</label>
        <input v-model="oldPassword" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />

        <label class="block text-gray-700 font-semibold mt-4 mb-1">üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:</label>
        <input v-model="newPassword" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300" />

        <button @click="updatePasswordHandler" class="w-full mt-2 py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-xl shadow transition">
          üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        </button>
        <p v-if="passwordMessage" :class="isPasswordSuccess ? 'text-green-600' : 'text-red-600'" class="mt-1">
          {{ passwordMessage }}
        </p>
      </div>

      <!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <button @click="saveProfile" class="w-full py-2.5 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-medium rounded-xl shadow transition">
        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
      </button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { getAuth, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential, updateProfile } from 'firebase/auth'
import { db } from '@/firebase/firebaseConfig'
import { doc, setDoc, getDoc, serverTimestamp } from 'firebase/firestore'

const displayName = ref('')
const avatar = ref('')
const userEmail = ref('')
const oldPassword = ref('')
const newPassword = ref('')
const passwordMessage = ref('')
const isPasswordSuccess = ref(false)
const favoriteSpices = ref('')
const favoriteMethods = ref('')

const favoriteMeat = ref('')
const favoriteVegetables = ref('')
const role = ref('')
const isAdmin = ref(false)

onMounted(() => {
  const auth = getAuth()
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userEmail.value = user.email
      const userDoc = await getDoc(doc(db, 'users', user.uid))
      if (userDoc.exists()) {
        const data = userDoc.data()
        displayName.value = data.displayName || ''
        avatar.value = data.avatar || ''
        favoriteMeat.value = data.favoriteMeat || ''
        favoriteVegetables.value = data.favoriteVegetables || ''
        favoriteSpices.value = data.favoriteSpices || ''       // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        favoriteMethods.value = data.favoriteMethods || '' 
        role.value = data.role || ''
        isAdmin.value = data.isAdmin || false
      }
    }
  })
})

const updatePasswordHandler = async () => {
  if (!oldPassword.value || !newPassword.value || newPassword.value.length < 6) {
    passwordMessage.value = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"
    isPasswordSuccess.value = false
    return
  }

  const auth = getAuth()
  const user = auth.currentUser
  if (!user) {
    passwordMessage.value = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô"
    isPasswordSuccess.value = false
    return
  }

  try {
    const credential = EmailAuthProvider.credential(user.email, oldPassword.value)
    await reauthenticateWithCredential(user, credential)
    await updatePassword(user, newPassword.value)

    passwordMessage.value = "‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"
    isPasswordSuccess.value = true
    oldPassword.value = ''
    newPassword.value = ''
  } catch (err) {
    console.error("‚ùå Error updating password:", err)
    passwordMessage.value = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message
    isPasswordSuccess.value = false
  }
}

const saveProfile = async () => {
  const auth = getAuth()
  const user = auth.currentUser

  if (!user) {
    console.log("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô")
    return
  }

  try {
    await updateProfile(user, {
      displayName: displayName.value,
      photoURL: avatar.value
    })

    await setDoc(doc(db, 'users', user.uid), {
      displayName: displayName.value,
      avatar: avatar.value,
      email: userEmail.value,
      favoriteMeat: favoriteMeat.value,
      favoriteVegetables: favoriteVegetables.value,
      favoriteSpices: favoriteSpices.value,       // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      favoriteMethods: favoriteMethods.value,
      role: role.value,
      isAdmin: isAdmin.value,
      updatedAt: serverTimestamp()
    }, { merge: true })

    passwordMessage.value = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"
    isPasswordSuccess.value = true
  } catch (err) {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err)
    passwordMessage.value = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message
    isPasswordSuccess.value = false
  }
}
</script>

<style scoped>
/* ‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
</style>
